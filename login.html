<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <title>Login - Auth System</title>
  <link rel="stylesheet" href="login.css">
</head>

<body>
  <div class="container">
    <!-- Lottie Animation -->
    <lottie-player
      src="Animation - 1744470672068.json"
      background="transparent"
      speed="1"
      loop
      autoplay>
    </lottie-player>

    <!-- Login Box -->
    <div class="signup-box">
      <h2>Log In</h2>
      <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Log In Account</button>
      </form>

      <p class="signup-link">
        Don't have an account? 
        <a href="sign up.html" style="color: red; text-decoration: none;">Sign up here</a>
      </p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJJXIRHOm__HnLSKI0vdnPKnVLVb7fMr4",
      authDomain: "login-auth-4be0b.firebaseapp.com",
      projectId: "login-auth-4be0b",
      storageBucket: "login-auth-4be0b.appspot.com",
      messagingSenderId: "55538485758",
      appId: "1:55538485758:web:c5b500a54f5a6333ef18af",
      measurementId: "G-SM4HMTPW82"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.getElementById("loginForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        // Check if user exists in Firestore 'users' collection
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          alert("Account not found in the database. Please sign up first.");
          return;
        }

        // If user is found in database, allow login
        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            alert("Login successful!");
            fetch("loginpages/dashboard.html")
              .then(response => {
                if (response.ok) {
                  window.location.href = "loginpages/dashboard.html";
                } else {
                  window.location.href = "404.html";
                }
              })
              .catch(() => {
                window.location.href = "404.html";
              });
          })
          .catch((error) => {
            alert("Login failed: " + error.message);
          });

      } catch (error) {
        console.error("Error checking user in database: ", error);
        alert("Something went wrong. Try again later.");
      }
    });
  </script>
</body>
</html>
